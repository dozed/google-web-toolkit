<?xml version='1.0' encoding='windows-1252'?>
<Wix
  xmlns='http://schemas.microsoft.com/wix/2006/wi'>

  <!-- Variables. -->
  <?define appName = "Google Web Toolkit Developer Plugin for IE" ?>
  <?if $(var.platform)=x64 ?>
  <?define upgradeCode = "9a5e649a-ec63-4c7d-99bf-75adb345e7e5" ?>
  <?define win64Flag = "yes" ?>
  <?else ?>
  <?define upgradeCode = "53DAE7D2-8C28-440F-920B-B2D665CE73B2" ?>
  <?define win64Flag = "no" ?>
  <?endif ?>
  <?define updateRegKey = "SOFTWARE\Google\Update\Clients\{$(var.upgradeCode)}" ?>
  <?define gwtRegKey = "SOFTWARE\Google\Google Web Toolkit\Installer" ?>

  <!--
    The main product to install. We generate a new GUID (*) on each
    compile to ensure that windows installer completely removes the old
    version and reinstalls the new version without complaining.
  -->

  <Product
    Name='$(var.appName) ($(var.platform))'
    Id='*'
    UpgradeCode='$(var.upgradeCode)'
    Language='1033'
    Codepage='1252'
    Version='$(var.version)'
    Manufacturer='Google'>

    <?if $(var.platform)=x64 ?>
    <Package
		  Id='*'
		  Keywords='Installer'
		  Description='$(var.appName) ($(var.platform))'
		  Manufacturer='Google'
		  InstallPrivileges='limited'
		  InstallerVersion='200'
		  Languages='1033'
		  Compressed='yes'
		  SummaryCodepage='1252'
		  Platform='x64'
		/>
    <?else ?>
    <Package
		  Id='*'
		  Keywords='Installer'
		  Description='$(var.appName) ($(var.platform))'
		  Manufacturer='Google'
		  InstallPrivileges='limited'
		  InstallerVersion='200'
		  Languages='1033'
		  Compressed='yes'
		  SummaryCodepage='1252'
		/>
    <?endif ?>

    <Media Id='1' Cabinet='product.cab' EmbedCab='yes' />

    <Icon Id="gwt.ico" SourceFile=".\gwt.ico"/>

	<!-- Properties -->
    <Property Id='REBOOT'>ReallySuppress</Property>
    <Property Id="ALLUSERS" Secure="yes"></Property>
    <Property Id="ARPPRODUCTICON" Value="gwt.ico" />
    <Property Id="ARPCOMMENTS" Value="Google Web Toolkit Developer Plugin for IE ($(var.platform))" />
    <Property Id="ARPNOMODIFY" Value="1" />
    <Property Id="ARPNOREPAIR" Value="1" />
    <Property Id="ARPHELPLINK" Value="http://code.google.com/webtoolkit/" />
    <Property Id="ARPURLINFOABOUT" Value="http://code.google.com/webtoolkit/" />

    <Upgrade Id='$(var.upgradeCode)'>
		<UpgradeVersion Property='UPGRADING'
                  OnlyDetect='no'
                  Minimum='0.0.0.0' IncludeMinimum='yes'
                  Maximum='$(var.version)' IncludeMaximum='no' />
		<UpgradeVersion Property='NEWERVERSIONDETECTED'
                  OnlyDetect='yes'
                  Minimum='$(var.version)' IncludeMinimum='yes' />
    </Upgrade>

    <InstallExecuteSequence>
      <LaunchConditions After='AppSearch' />
      <RemoveExistingProducts After='InstallValidate' />
	  <Custom Action="NewerVersionError" After="FindRelatedProducts">NEWERVERSIONDETECTED</Custom>
    </InstallExecuteSequence>

	<UI>
		<Error Id="4000">A newer version of this product is already installed.</Error>
	</UI>

	<CustomAction Id="NewerVersionError" Error="4000"/>
	
    <!-- Define the install directory. -->
    <?if $(var.platform)=x64 ?>
    <Directory Id='TARGETDIR'	Name='SourceDir'>
      <Directory Id='AppDataFolder' Name='AppData'>
        <Directory Id='GoogleDir' Name='Google'>
          <Component Id="RemoveGoogleDir" Guid="*" DiskId="1" Win64="$(var.win64Flag)">
            <CreateFolder/>
            <RemoveFolder Id="RemoveGoogleDirFolder" On="uninstall" />
            <RegistryKey Root="HKMU" Key="$(var.gwtRegKey)" Action="createAndRemoveOnUninstall">
              <RegistryValue Name="RemoveGoogleDirFolder" Value="" Type="string" KeyPath="yes"/>
            </RegistryKey>
          </Component>
          <Directory Id='GoogleWebToolkitDir' Name='Google Web Toolkit'>
            <Component Id="RemoveGoogleWebToolkitDir" Guid="*" DiskId="1" Win64="$(var.win64Flag)">
              <CreateFolder/>
              <RemoveFolder Id="RemoveGoogleWebToolkitDirFolder" On="uninstall" />
              <RegistryKey Root="HKMU" Key="$(var.gwtRegKey)" Action="createAndRemoveOnUninstall">
                <RegistryValue Name="RemoveGoogleWebToolkitDirFolder" Value="" Type="string" KeyPath="yes"/>
              </RegistryKey>
            </Component>
            <Directory Id='DeveloperPluginDir' Name='Developer Plugin'>
              <Component Id="RemoveDeveloperPluginDir" Guid="*" DiskId="1" Win64="$(var.win64Flag)">
                <CreateFolder/>
                <RemoveFolder Id="RemoveDeveloperPluginDirFolder" On="uninstall" />
                <RegistryKey Root="HKMU" Key="$(var.gwtRegKey)" Action="createAndRemoveOnUninstall">
                  <RegistryValue Name="RemoveDeveloperPluginDirFolder" Value="" Type="string" KeyPath="yes"/>
                </RegistryKey>
              </Component>
              <Directory Id='INSTALLDIR' Name='IE'>
                <Component Id="RemoveInstallDir" Guid="*" DiskId="1" Win64="$(var.win64Flag)">
                  <CreateFolder/>
                  <RemoveFolder Id="RemoveInstallerDirFolder" On="uninstall" />
                  <RegistryKey Root="HKMU" Key="$(var.gwtRegKey)" Action="createAndRemoveOnUninstall">
                    <RegistryValue Name="RemoveInstallerDirFolder" Value="" Type="string" KeyPath="yes"/>
                  </RegistryKey>
                </Component>
			  </Directory>
            </Directory>
          </Directory>
        </Directory>
      </Directory>
    </Directory>
    <?else?>
    <Directory Id='TARGETDIR'	Name='SourceDir'>
      <Directory Id='AppDataFolder' Name='AppData'>
        <Directory Id='GoogleDir' Name='Google'>
          <Component Id="RemoveGoogleDir" Guid="*" DiskId="1" Win64="$(var.win64Flag)">
            <CreateFolder/>
            <RemoveFolder Id="RemoveGoogleDirFolder" On="uninstall" />
            <RegistryKey Root="HKMU" Key="$(var.gwtRegKey)" Action="createAndRemoveOnUninstall">
              <RegistryValue Name="RemoveGoogleDirFolder" Value="" Type="string" KeyPath="yes"/>
            </RegistryKey>
          </Component>
          <Directory Id='GoogleWebToolkitDir' Name='Google Web Toolkit'>
            <Component Id="RemoveGoogleWebToolkitDir" Guid="*" DiskId="1" Win64="$(var.win64Flag)">
              <CreateFolder/>
              <RemoveFolder Id="RemoveGoogleWebToolkitDirFolder" On="uninstall" />
              <RegistryKey Root="HKMU" Key="$(var.gwtRegKey)" Action="createAndRemoveOnUninstall">
                <RegistryValue Name="RemoveGoogleWebToolkitDirFolder" Value="" Type="string" KeyPath="yes"/>
              </RegistryKey>
            </Component>
            <Directory Id='DeveloperPluginDir' Name='Developer Plugin'>
              <Component Id="RemoveDeveloperPluginDir" Guid="*" DiskId="1" Win64="$(var.win64Flag)">
                <CreateFolder/>
                <RemoveFolder Id="RemoveDeveloperPluginDirFolder" On="uninstall" />
                <RegistryKey Root="HKMU" Key="$(var.gwtRegKey)" Action="createAndRemoveOnUninstall">
                  <RegistryValue Name="RemoveDeveloperPluginDirFolder" Value="" Type="string" KeyPath="yes"/>
                </RegistryKey>
              </Component>
              <Directory Id='INSTALLDIR' Name='IE'>
                <Component Id="RemoveInstallDir" Guid="*" DiskId="1" Win64="$(var.win64Flag)">
                  <CreateFolder/>
                  <RemoveFolder Id="RemoveInstallerDirFolder" On="uninstall" />
                  <RegistryKey Root="HKMU" Key="$(var.gwtRegKey)" Action="createAndRemoveOnUninstall">
                    <RegistryValue Name="RemoveInstallerDirFolder" Value="" Type="string" KeyPath="yes"/>
                  </RegistryKey>
                </Component>
              </Directory>
            </Directory>
          </Directory>
        </Directory>
      </Directory>
    </Directory>
    <?endif?>

    <!-- Set some registry values. -->
    <Component Id='registryValues' Directory='INSTALLDIR' Guid='*' Win64="$(var.win64Flag)">
      <RegistryKey Root='HKMU' Action='createAndRemoveOnUninstall' Key='$(var.updateRegKey)'>
        <RegistryValue Name='pv' Value='$(var.version)' Type='string' />
        <RegistryValue Name='name' Value='$(var.appName)' Type='string' />
        <RegistryValue Name='lang' Value='en' Type='string' />
      </RegistryKey>
	  <!-- requires per machine install (elevated)
      <RegistryKey Root='HKMU' Action='createAndRemoveOnUninstall' Key='SOFTWARE\Microsoft\Windows\CurrentVersion\explorer\Browser Helper Objects\{1D6156B6-002B-49E7-B5CA-C138FB843B4E}'>
        <RegistryValue Name='NoExplorer' Value='1' Type='integer' />
      </RegistryKey>
	  -->
    </Component>

    <!-- Define the features to install. -->
    <Feature Id='CompleteFeature' Display='expand' Level='1' Absent='disallow'>
      <!--
        Loaded from oophm.wxs.xml, which is generated by the build
        script.
        -->
      <ComponentRef Id='RemoveGoogleDir' />
      <ComponentRef Id='RemoveGoogleWebToolkitDir' />
      <ComponentRef Id='RemoveDeveloperPluginDir' />
      <ComponentRef Id='RemoveInstallDir' />
      <ComponentGroupRef Id='oophmDll' />
      <ComponentRef Id='registryValues' />
    </Feature>
  </Product>
</Wix>
